---
kind: Template
apiVersion: v1
metadata:
  name: graphql-lab
  annotations:
    description: Database and application server
labels:
  template: graphql-lab-template
objects:
  - apiVersion: apps/v1
    kind: Deployment
    metadata: &metadata
      name: "$(APP_NAME)"
      namespace: $(NAMESPACE)
      labels: &labels
        app: "$(APP_NAME)"
        purpose: learning-lab
    spec:
      replicas: $((REPLICA_COUNT))
      selector:
        matchLabels: *labels
      template:
        metadata:
          labels: *labels
        spec:
          containers:
            - name: graphql-js
              image: $(IMAGE_URI)
              ports:
                - containerPort: $((HTTP_PORT))
              envFrom:
                - secretRef:
                    name: $(APP_NAME)-admin
              readinessProbe:
                httpGet: &httpStatusCheck
                  path: /
                  port: $((HTTP_PORT))
                initialDelaySeconds: 10
                periodSeconds: 5
              livenessProbe:
                httpGet: *httpStatusCheck
                initialDelaySeconds: 10
                periodSeconds: 60
  - apiVersion: v1
    kind: Service
    metadata: *metadata
    spec:
      selector: *labels
      ports:
        - protocol: TCP
          port: $((HTTP_PORT))
  - apiVersion: extensions/v1beta1
    kind: Ingress
    metadata:
      name: "$(APP_NAME)"
      namespace: $(NAMESPACE)
      labels:
        app: "$(APP_NAME)"
        purpose: learning-lab
      annotations:
        "kubernetes.io/tls-acme": "true"
    spec:
      rules:
        - host: "$(APP_NAME).training.svc.platform.myobdev.com"
          http:
            paths:
              - backend:
                  serviceName: "$(APP_NAME)"
                  servicePort: $((HTTP_PORT))
                path: /
      tls:
        - hosts:
            - "$(APP_NAME).training.svc.platform.myobdev.com"
          secretName: "$(APP_NAME)-tls"

parameters:
  - name: "NAMESPACE"
    description: "Kubernetes cluster namespace"
    required: true
    parameterType: "string"
  - name: "APP_NAME"
    description: "Name of the application"
    required: true
    parameterType: "string"
  - name: "IMAGE_URI"
    description: "Docker image URI"
    required: true
    parameterType: "string"
  - name: "REPLICA_COUNT"
    description: "Number of replicas for graphql-js server"
    required: true
    parameterType: "int"
  - name: "HTTP_PORT"
    description: "Port in the container serving http requests"
    value: 4000
    required: true
    parameterType: "int"
